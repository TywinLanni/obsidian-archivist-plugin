# ArchivistBot Obsidian Plugin ‚Äî –ü–æ–ª–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

–°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å (core + community) —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞. REST API —Ä–∞–±–æ—Ç–∞–µ—Ç:
- `GET /health` ‚Üí `{ status, version }`
- `GET /notes/unsynced` ‚Üí –∑–∞–º–µ—Ç–∫–∏, –æ–∂–∏–¥–∞—é—â–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `GET /notes/{id}` ‚Üí –æ–¥–Ω–∞ –∑–∞–º–µ—Ç–∫–∞
- `POST /notes/mark-synced` ‚Üí –ø–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ

–°–µ–π—á–∞—Å –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞. –ù—É–∂–µ–Ω Obsidian plugin, –∫–æ—Ç–æ—Ä—ã–π:
1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –∑–∞–º–µ—Ç–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ –≤ vault
2. –ó–∞–º–µ–Ω—è–µ—Ç Templater-–∫–æ—Å—Ç—ã–ª—å –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –Ω–∞ –Ω–∞—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É

---

## 1 ¬∑ –®–∞–±–ª–æ–Ω –ø—Ä–æ–µ–∫—Ç–∞

### –ü–æ—á–µ–º—É –ù–ï IntelliJ ‚Üí React

–°–∫—Ä–∏–Ω—à–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç IntelliJ New Project ‚Üí React. **–≠—Ç–æ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç.** Obsidian plugin ‚Äî —ç—Ç–æ:
- **CommonJS** –º–æ–¥—É–ª—å (–Ω–µ ESM, –Ω–µ React app)
- –ë–∞–Ω–¥–ª–∏—Ç—Å—è **esbuild** –≤ –æ–¥–∏–Ω `main.js`
- `obsidian` ‚Äî **external** –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å (–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è Obsidian runtime)
- –ù–∏–∫–∞–∫–æ–≥–æ React, Vite, webpack ‚Äî —á–∏—Å—Ç—ã–π TypeScript ‚Üí esbuild ‚Üí CJS bundle

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω

–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π: **[obsidianmd/obsidian-sample-plugin](https://github.com/obsidianmd/obsidian-sample-plugin)** ‚Äî "Use this template" –Ω–∞ GitHub.

–ù–æ –ø–æ—Å–∫–æ–ª—å–∫—É plugin –∂–∏–≤—ë—Ç –≤–Ω—É—Ç—Ä–∏ –º–æ–Ω–æ—Ä–µ–ø—ã `ArchivistBot/plugin/`, –Ω–µ –Ω—É–∂–Ω–æ —Ñ–æ—Ä–∫–∞—Ç—å. –ù—É–∂–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä—É–∫–∞–º–∏.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
plugin/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main.ts              ‚Üê Plugin entry point
‚îÇ   ‚îú‚îÄ‚îÄ settings.ts          ‚Üê SettingTab + interface
‚îÇ   ‚îú‚îÄ‚îÄ api-client.ts        ‚Üê REST –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ sync-engine.ts       ‚Üê polling + mark-synced
‚îÇ   ‚îú‚îÄ‚îÄ note-writer.ts       ‚Üê NoteResponse ‚Üí .md –≤ vault
‚îÇ   ‚îú‚îÄ‚îÄ archiver.ts          ‚Üê Archive Note (–∑–∞–º–µ–Ω–∞ Templater)
‚îÇ   ‚îî‚îÄ‚îÄ types.ts             ‚Üê TypeScript —Ç–∏–ø—ã (–∏–∑ Core OpenAPI –∏–ª–∏ —Ä—É–∫–∞–º–∏)
‚îú‚îÄ‚îÄ styles.css
‚îú‚îÄ‚îÄ manifest.json
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ esbuild.config.mjs
‚îú‚îÄ‚îÄ version-bump.mjs
‚îú‚îÄ‚îÄ versions.json
‚îî‚îÄ‚îÄ .gitignore
```

### Output (—á—Ç–æ Obsidian –∑–∞–≥—Ä—É–∂–∞–µ—Ç)

```
.obsidian/plugins/archivistbot/
‚îú‚îÄ‚îÄ main.js                   ‚Üê –±–∞–Ω–¥–ª
‚îú‚îÄ‚îÄ manifest.json
‚îî‚îÄ‚îÄ styles.css
```

---

## 2 ¬∑ Scaffold-—Ñ–∞–π–ª—ã

### manifest.json

```json
{
  "id": "archivistbot",
  "name": "ArchivistBot",
  "version": "0.1.0",
  "minAppVersion": "1.5.0",
  "description": "Sync voice notes from ArchivistBot to your vault with auto-categorization",
  "author": "TywinLanni",
  "authorUrl": "https://github.com/TywinLanni",
  "isDesktopOnly": false
}
```

### package.json

```json
{
  "name": "obsidian-archivistbot",
  "version": "0.1.0",
  "description": "ArchivistBot Obsidian plugin ‚Äî voice note sync & archive",
  "main": "main.js",
  "scripts": {
    "dev": "node esbuild.config.mjs",
    "build": "tsc -noEmit -skipLibCheck && node esbuild.config.mjs production",
    "version": "node version-bump.mjs && git add manifest.json versions.json"
  },
  "keywords": ["obsidian", "voice-notes", "telegram", "archivistbot"],
  "author": "TywinLanni",
  "license": "MIT",
  "devDependencies": {
    "@types/node": "^22.0.0",
    "@typescript-eslint/eslint-plugin": "^8.0.0",
    "@typescript-eslint/parser": "^8.0.0",
    "builtin-modules": "^4.0.0",
    "esbuild": "^0.24.0",
    "obsidian": "latest",
    "tslib": "^2.8.0",
    "typescript": "^5.6.0"
  }
}
```

### tsconfig.json

```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "inlineSourceMap": true,
    "inlineSources": true,
    "module": "ESNext",
    "target": "ESNext",
    "lib": ["ESNext", "DOM"],
    "moduleResolution": "node",
    "allowJs": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "noUnusedLocals": true,
    "esModuleInterop": true,
    "noEmit": true,
    "isolatedModules": true,
    "resolveJsonModule": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src/**/*.ts"],
  "exclude": ["node_modules"]
}
```

### esbuild.config.mjs

```javascript
import esbuild from "esbuild";
import process from "process";
import builtins from "builtin-modules";

const banner = `/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
`;

const prod = process.argv[2] === "production";

const context = await esbuild.context({
  banner: { js: banner },
  entryPoints: ["src/main.ts"],
  bundle: true,
  external: [
    "obsidian",
    "electron",
    "@codemirror/autocomplete",
    "@codemirror/collab",
    "@codemirror/commands",
    "@codemirror/language",
    "@codemirror/lint",
    "@codemirror/search",
    "@codemirror/state",
    "@codemirror/view",
    "@lezer/common",
    "@lezer/highlight",
    "@lezer/lr",
    ...builtins,
  ],
  format: "cjs",
  target: "es2018",
  logLevel: "info",
  sourcemap: prod ? false : "inline",
  treeShaking: true,
  outfile: "main.js",
  minify: prod,
});

if (prod) {
  await context.rebuild();
  process.exit(0);
} else {
  await context.watch();
}
```

### .gitignore (plugin/)

```
node_modules/
main.js
*.js.map
dist/
```

---

## 3 ¬∑ –¢–∏–ø—ã (–∫–æ–Ω—Ç—Ä–∞–∫—Ç —Å —Å–µ—Ä–≤–µ—Ä–æ–º)

–ò–∑ README ‚Äî —Ç–µ–∫—É—â–∏–π REST API:

```
GET  /notes/unsynced     ‚Üí NoteResponse[]
GET  /notes/{id}         ‚Üí NoteResponse
POST /notes/mark-synced  ‚Üí { ids: string[] }
GET  /health             ‚Üí { status, version }
```

### types.ts

```typescript
// src/types.ts
// –ó–µ—Ä–∫–∞–ª–æ Core Pydantic –º–æ–¥–µ–ª–µ–π

export interface NoteResponse {
  id: string;
  title: string;
  content: string;           // raw transcript
  markdown: string;          // –≥–æ—Ç–æ–≤—ã–π .md —Å frontmatter
  category: string;
  subcategory: string | null;
  tags: string[];
  summary: string;
  created_at: string;        // ISO datetime
  source: string;            // "telegram"
}

export interface HealthResponse {
  status: string;
  version: string;
}

export interface MarkSyncedRequest {
  ids: string[];
}

export interface MarkSyncedResponse {
  synced: number;
}
```

‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –í –±—É–¥—É—â–µ–º ‚Äî –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑ Core OpenAPI. –ù–∞ MVP ‚Äî —Ä—É–∫–∞–º–∏, –Ω–æ –¥–µ—Ä–∂–∞—Ç—å –≤ sync —Å `core/src/archivistbot_core/models/`.

---

## 4 ¬∑ –ú–æ–¥—É–ª–∏

### 4.1 ¬∑ Settings

```typescript
// src/settings.ts
import { App, PluginSettingTab, Setting } from "obsidian";
import type ArchivistBotPlugin from "./main";

export interface ArchivistBotSettings {
  endpoint: string;
  authToken: string;
  syncIntervalSec: number;
  vaultBasePath: string;       // –∫–æ—Ä–µ–Ω—å –¥–ª—è –∑–∞–º–µ—Ç–æ–∫ –≤ vault
  autoSync: boolean;
}

export const DEFAULT_SETTINGS: ArchivistBotSettings = {
  endpoint: "http://localhost:8000",
  authToken: "",
  syncIntervalSec: 60,
  vaultBasePath: "VoiceNotes",
  autoSync: true,
};

export class ArchivistBotSettingTab extends PluginSettingTab {
  plugin: ArchivistBotPlugin;

  constructor(app: App, plugin: ArchivistBotPlugin) {
    super(app, plugin);
    this.plugin = plugin;
  }

  display(): void {
    const { containerEl } = this;
    containerEl.empty();

    new Setting(containerEl)
      .setName("Server URL")
      .setDesc("ArchivistBot API endpoint")
      .addText((text) =>
        text
          .setPlaceholder("http://localhost:8000")
          .setValue(this.plugin.settings.endpoint)
          .onChange(async (value) => {
            this.plugin.settings.endpoint = value;
            await this.plugin.saveSettings();
          })
      );

    new Setting(containerEl)
      .setName("Auth Token")
      .setDesc("Bearer token (for SaaS mode, leave empty for local)")
      .addText((text) =>
        text
          .setValue(this.plugin.settings.authToken)
          .onChange(async (value) => {
            this.plugin.settings.authToken = value;
            await this.plugin.saveSettings();
          })
      );

    new Setting(containerEl)
      .setName("Sync interval")
      .setDesc("Seconds between sync checks")
      .addSlider((slider) =>
        slider
          .setLimits(10, 300, 10)
          .setValue(this.plugin.settings.syncIntervalSec)
          .setDynamicTooltip()
          .onChange(async (value) => {
            this.plugin.settings.syncIntervalSec = value;
            await this.plugin.saveSettings();
            this.plugin.restartSync();
          })
      );

    new Setting(containerEl)
      .setName("Vault base path")
      .setDesc("Folder for synced notes (e.g. VoiceNotes)")
      .addText((text) =>
        text
          .setValue(this.plugin.settings.vaultBasePath)
          .onChange(async (value) => {
            this.plugin.settings.vaultBasePath = value;
            await this.plugin.saveSettings();
          })
      );

    new Setting(containerEl)
      .setName("Auto sync")
      .setDesc("Automatically sync notes on interval")
      .addToggle((toggle) =>
        toggle.setValue(this.plugin.settings.autoSync).onChange(async (value) => {
          this.plugin.settings.autoSync = value;
          await this.plugin.saveSettings();
          if (value) this.plugin.startSync();
          else this.plugin.stopSync();
        })
      );
  }
}
```

### 4.2 ¬∑ API Client

```typescript
// src/api-client.ts
import { requestUrl, RequestUrlParam } from "obsidian";
import type { NoteResponse, HealthResponse, MarkSyncedResponse } from "./types";
import type { ArchivistBotSettings } from "./settings";

/**
 * REST –∫–ª–∏–µ–Ω—Ç –¥–ª—è ArchivistBot API.
 *
 * –ò—Å–ø–æ–ª—å–∑—É–µ–º obsidian requestUrl() –≤–º–µ—Å—Ç–æ fetch() ‚Äî
 * –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –≤ Desktop, –∏ –≤ Mobile, –æ–±—Ö–æ–¥–∏—Ç CORS.
 */
export class ArchivistApiClient {
  constructor(private getSettings: () => ArchivistBotSettings) {}

  private get baseUrl(): string {
    return this.getSettings().endpoint.replace(/\/+$/, "");
  }

  private get headers(): Record<string, string> {
    const h: Record<string, string> = { "Content-Type": "application/json" };
    const token = this.getSettings().authToken;
    if (token) {
      h["Authorization"] = `Bearer ${token}`;
    }
    return h;
  }

  async health(): Promise<HealthResponse> {
    const resp = await requestUrl({
      url: `${this.baseUrl}/health`,
      headers: this.headers,
    });
    return resp.json;
  }

  async fetchUnsynced(): Promise<NoteResponse[]> {
    const resp = await requestUrl({
      url: `${this.baseUrl}/notes/unsynced`,
      headers: this.headers,
    });
    return resp.json;
  }

  async markSynced(ids: string[]): Promise<MarkSyncedResponse> {
    const resp = await requestUrl({
      url: `${this.baseUrl}/notes/mark-synced`,
      method: "POST",
      headers: this.headers,
      body: JSON.stringify({ ids }),
    });
    return resp.json;
  }
}
```

‚ö†Ô∏è **`requestUrl`** ‚Äî —ç—Ç–æ Obsidian API. –ù–µ `fetch()`. –ü—Ä–∏—á–∏–Ω—ã:
- –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –º–æ–±–∞–π–ª–µ
- –û–±—Ö–æ–¥–∏—Ç CORS (Obsidian –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —É—Ä–æ–≤–Ω–µ Electron/native)
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –≤ –ø–ª–∞–≥–∏–Ω–∞—Ö

### 4.3 ¬∑ Note Writer

```typescript
// src/note-writer.ts
import { Vault, normalizePath, TFolder } from "obsidian";
import type { NoteResponse } from "./types";

export class NoteWriter {
  constructor(
    private vault: Vault,
    private basePath: string
  ) {}

  async write(note: NoteResponse): Promise<string | null> {
    const parts = [this.basePath, note.category];
    if (note.subcategory) parts.push(note.subcategory);

    const dir = normalizePath(parts.join("/"));
    await this.ensureFolder(dir);

    const fileName = this.sanitize(note.title);
    let filePath = normalizePath(`${dir}/${fileName}.md`);

    // –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: –µ—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    if (this.vault.getAbstractFileByPath(filePath)) {
      return null;
    }

    await this.vault.create(filePath, note.markdown);
    return filePath;
  }

  private async ensureFolder(path: string): Promise<void> {
    const existing = this.vault.getAbstractFileByPath(path);
    if (existing instanceof TFolder) return;

    // —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ
    const parts = path.split("/");
    let current = "";
    for (const part of parts) {
      current = current ? `${current}/${part}` : part;
      const folder = this.vault.getAbstractFileByPath(current);
      if (!folder) {
        await this.vault.createFolder(current);
      }
    }
  }

  private sanitize(name: string): string {
    return name
      .replace(/[\\/:*?"<>|#^[\]]/g, "_")
      .replace(/\s+/g, " ")
      .trim()
      .slice(0, 100);
  }
}
```

### 4.4 ¬∑ Sync Engine

```typescript
// src/sync-engine.ts
import { Notice } from "obsidian";
import type { ArchivistApiClient } from "./api-client";
import type { NoteWriter } from "./note-writer";

export class SyncEngine {
  private intervalId: number | null = null;
  private syncing = false;

  constructor(
    private client: ArchivistApiClient,
    private writer: NoteWriter,
    private registerInterval: (id: number) => void
  ) {}

  start(intervalSec: number): void {
    this.stop();
    // immediate first sync
    this.sync();
    this.intervalId = window.setInterval(
      () => this.sync(),
      intervalSec * 1000
    );
    this.registerInterval(this.intervalId);
  }

  stop(): void {
    if (this.intervalId !== null) {
      window.clearInterval(this.intervalId);
      this.intervalId = null;
    }
  }

  async sync(): Promise<void> {
    if (this.syncing) return; // guard –æ—Ç –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è
    this.syncing = true;

    try {
      const notes = await this.client.fetchUnsynced();
      if (notes.length === 0) return;

      const written: string[] = [];
      const syncedIds: string[] = [];

      for (const note of notes) {
        const path = await this.writer.write(note);
        if (path) written.push(path);
        syncedIds.push(note.id);
      }

      if (syncedIds.length > 0) {
        await this.client.markSynced(syncedIds);
      }

      if (written.length > 0) {
        new Notice(`üìù ArchivistBot: synced ${written.length} note(s)`);
      }
    } catch (e) {
      console.error("[ArchivistBot] sync error:", e);
      // –ù–µ —Å–ø–∞–º–∏–º Notice –Ω–∞ –∫–∞–∂–¥–æ–º interval ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä—É—á–Ω–æ–º sync
    } finally {
      this.syncing = false;
    }
  }
}
```

### 4.5 ¬∑ Archiver (–∑–∞–º–µ–Ω–∞ Templater-—Å–∫—Ä–∏–ø—Ç–∞)

–¢–µ–∫—É—â–∏–π Templater-—Å–∫—Ä–∏–ø—Ç –¥–µ–ª–∞–µ—Ç:
1. Suggester: realized / dropped / outdated
2. –û–±–Ω–æ–≤–ª—è–µ—Ç frontmatter: resolution + archived_at
3. –ü–µ—Ä–µ–º–µ—â–∞–µ—Ç –≤ `_archive/{category_path}/`
4. –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏

**–ó–∞–º–µ–Ω–∞:**

```typescript
// src/archiver.ts
import {
  App,
  TFile,
  Notice,
  Modal,
  Setting,
  normalizePath,
  TFolder,
} from "obsidian";

const RESOLUTIONS = [
  { value: "realized", label: "‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ" },
  { value: "dropped", label: "‚ùå –û—Ç–±—Ä–æ—à–µ–Ω–æ" },
  { value: "outdated", label: "‚è∞ –£—Å—Ç–∞—Ä–µ–ª–æ" },
] as const;

type Resolution = (typeof RESOLUTIONS)[number]["value"];

/**
 * Modal –¥–ª—è –≤—ã–±–æ—Ä–∞ resolution –ø—Ä–∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏.
 */
class ArchiveModal extends Modal {
  private resolve: ((value: Resolution | null) => void) | null = null;

  constructor(app: App) {
    super(app);
  }

  pick(): Promise<Resolution | null> {
    return new Promise((resolve) => {
      this.resolve = resolve;
      this.open();
    });
  }

  onOpen(): void {
    const { contentEl } = this;
    contentEl.createEl("h3", { text: "üì¶ –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É" });
    contentEl.createEl("p", { text: "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É:" });

    for (const { value, label } of RESOLUTIONS) {
      new Setting(contentEl).addButton((btn) =>
        btn
          .setButtonText(label)
          .setCta()
          .onClick(() => {
            this.resolve?.(value);
            this.close();
          })
      );
    }
  }

  onClose(): void {
    // –ï—Å–ª–∏ –∑–∞–∫—Ä—ã–ª–∏ –±–µ–∑ –≤—ã–±–æ—Ä–∞
    this.resolve?.(null);
    this.contentEl.empty();
  }
}

/**
 * –ê—Ä—Ö–∏–≤–∞—Ç–æ—Ä –∑–∞–º–µ—Ç–æ–∫.
 * –ó–∞–º–µ–Ω—è–µ—Ç Templater-—Å–∫—Ä–∏–ø—Ç Archive Note.md.
 */
export class NoteArchiver {
  constructor(
    private app: App,
    private basePath: string // "VoiceNotes"
  ) {}

  /**
   * –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É: –≤—ã–±–æ—Ä resolution ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ frontmatter ‚Üí –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ.
   */
  async archive(file: TFile): Promise<void> {
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –≤ –∞—Ä—Ö–∏–≤–µ –ª–∏ —É–∂–µ
    if (file.path.includes("/_archive/")) {
      new Notice("‚ö†Ô∏è –ó–∞–º–µ—Ç–∫–∞ —É–∂–µ –≤ –∞—Ä—Ö–∏–≤–µ");
      return;
    }

    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ñ–∞–π–ª –≤–Ω—É—Ç—Ä–∏ basePath
    if (!file.path.startsWith(this.basePath + "/")) {
      new Notice("‚ö†Ô∏è –ù–µ —è–≤–ª—è–µ—Ç—Å—è –∑–∞–º–µ—Ç–∫–æ–π ArchivistBot");
      return;
    }

    // 3. –í—ã–±–æ—Ä resolution
    const modal = new ArchiveModal(this.app);
    const resolution = await modal.pick();
    if (!resolution) return; // –æ—Ç–º–µ–Ω–∞

    // 4. –û–±–Ω–æ–≤–∏—Ç—å frontmatter
    await this.app.fileManager.processFrontMatter(file, (fm) => {
      fm.resolution = resolution;
      fm.archived_at = new Date().toISOString().slice(0, 19); // YYYY-MM-DDTHH:mm:ss
    });

    // 5. –í—ã—á–∏—Å–ª–∏—Ç—å archive path
    const relativePath = file.path.slice(this.basePath.length + 1);
    // relativePath = "work/meetings/–∑–∞–º–µ—Ç–∫–∞.md"
    const lastSlash = relativePath.lastIndexOf("/");
    const categoryPath =
      lastSlash > 0 ? relativePath.slice(0, lastSlash) : "uncategorized";

    const archiveDir = normalizePath(
      `${this.basePath}/_archive/${categoryPath}`
    );
    const archivePath = normalizePath(`${archiveDir}/${file.name}`);

    // 6. –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫–∏ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ
    await this.ensureFolder(archiveDir);

    // 7. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å
    await this.app.fileManager.renameFile(file, archivePath);

    new Notice(`üì¶ Archived: ${resolution}`);
  }

  private async ensureFolder(path: string): Promise<void> {
    const existing = this.app.vault.getAbstractFileByPath(path);
    if (existing instanceof TFolder) return;

    const parts = path.split("/");
    let current = "";
    for (const part of parts) {
      current = current ? `${current}/${part}` : part;
      if (!this.app.vault.getAbstractFileByPath(current)) {
        await this.app.vault.createFolder(current);
      }
    }
  }
}
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç Templater-–∫–æ—Å—Ç—ã–ª—è:**

| –ê—Å–ø–µ–∫—Ç | Templater | Plugin |
|---|---|---|
| Frontmatter | –†—É—á–Ω–æ–π regex –ø–æ —Å—Ç—Ä–æ–∫–µ | `app.fileManager.processFrontMatter()` ‚Äî safe, atomic |
| Move | `tp.file.move()` (Templater API) | `app.fileManager.renameFile()` ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç –ª–∏–Ω–∫–∏ |
| UI | `tp.system.suggester()` | –ù–∞—Ç–∏–≤–Ω—ã–π `Modal` ‚Äî –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä—É–µ–º—ã–π, —Å–≤–æ–π –¥–∏–∑–∞–π–Ω |
| Trigger | –ù—É–∂–µ–Ω Templater + template file | Command palette + context menu + –∫–Ω–æ–ø–∫–∞ |
| –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å | Templater plugin –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω | Standalone, –Ω–æ–ª—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π |

### 4.6 ¬∑ Main (entry point)

```typescript
// src/main.ts
import { Plugin, TFile, MarkdownView, Notice } from "obsidian";
import {
  ArchivistBotSettings,
  DEFAULT_SETTINGS,
  ArchivistBotSettingTab,
} from "./settings";
import { ArchivistApiClient } from "./api-client";
import { NoteWriter } from "./note-writer";
import { SyncEngine } from "./sync-engine";
import { NoteArchiver } from "./archiver";

export default class ArchivistBotPlugin extends Plugin {
  settings: ArchivistBotSettings;
  private client: ArchivistApiClient;
  private syncEngine: SyncEngine;
  private archiver: NoteArchiver;

  async onload(): Promise<void> {
    await this.loadSettings();

    this.client = new ArchivistApiClient(() => this.settings);

    const writer = new NoteWriter(
      this.app.vault,
      this.settings.vaultBasePath
    );

    this.syncEngine = new SyncEngine(
      this.client,
      writer,
      (id) => this.registerInterval(id)
    );

    this.archiver = new NoteArchiver(
      this.app,
      this.settings.vaultBasePath
    );

    // ‚îÄ‚îÄ Settings Tab ‚îÄ‚îÄ
    this.addSettingTab(new ArchivistBotSettingTab(this.app, this));

    // ‚îÄ‚îÄ Ribbon Icon: Manual Sync ‚îÄ‚îÄ
    this.addRibbonIcon("refresh-cw", "ArchivistBot: Sync now", async () => {
      try {
        await this.syncEngine.sync();
      } catch (e) {
        new Notice(`‚ùå Sync failed: ${e}`);
      }
    });

    // ‚îÄ‚îÄ Commands ‚îÄ‚îÄ

    // Manual sync
    this.addCommand({
      id: "sync-now",
      name: "Sync notes now",
      callback: async () => {
        try {
          await this.syncEngine.sync();
        } catch (e) {
          new Notice(`‚ùå Sync failed: ${e}`);
        }
      },
    });

    // Health check
    this.addCommand({
      id: "health-check",
      name: "Check server connection",
      callback: async () => {
        try {
          const h = await this.client.health();
          new Notice(`‚úÖ Server OK (v${h.version})`);
        } catch (e) {
          new Notice(`‚ùå Server unreachable: ${e}`);
        }
      },
    });

    // Archive note
    this.addCommand({
      id: "archive-note",
      name: "üì¶ Archive note",
      checkCallback: (checking: boolean) => {
        const file = this.app.workspace.getActiveFile();
        if (!file) return false;
        if (!file.path.startsWith(this.settings.vaultBasePath + "/")) return false;
        if (file.path.includes("/_archive/")) return false;

        if (!checking) {
          this.archiver.archive(file);
        }
        return true;
      },
    });

    // ‚îÄ‚îÄ Context Menu: Archive ‚îÄ‚îÄ
    this.registerEvent(
      this.app.workspace.on("file-menu", (menu, file) => {
        if (!(file instanceof TFile)) return;
        if (!file.path.startsWith(this.settings.vaultBasePath + "/")) return;
        if (file.path.includes("/_archive/")) return;

        menu.addItem((item) =>
          item
            .setTitle("üì¶ Archive (ArchivistBot)")
            .setIcon("archive")
            .onClick(() => this.archiver.archive(file))
        );
      })
    );

    // ‚îÄ‚îÄ Auto Sync ‚îÄ‚îÄ
    if (this.settings.autoSync) {
      // –î–æ–∂–¥–∞—Ç—å—Å—è layout ready, –ø–æ—Ç–æ–º —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å
      this.app.workspace.onLayoutReady(() => {
        this.startSync();
      });
    }

    // ‚îÄ‚îÄ Status Bar ‚îÄ‚îÄ
    const statusBarEl = this.addStatusBarItem();
    statusBarEl.setText("üì° ArchivistBot");
  }

  onunload(): void {
    this.syncEngine.stop();
  }

  startSync(): void {
    this.syncEngine.start(this.settings.syncIntervalSec);
  }

  stopSync(): void {
    this.syncEngine.stop();
  }

  restartSync(): void {
    if (this.settings.autoSync) {
      this.stopSync();
      this.startSync();
    }
  }

  async loadSettings(): Promise<void> {
    this.settings = Object.assign(
      {},
      DEFAULT_SETTINGS,
      await this.loadData()
    );
  }

  async saveSettings(): Promise<void> {
    await this.saveData(this.settings);
  }
}
```

---

## 5 ¬∑ –ì–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è Archive

–¢—Ä–∏ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è:

| Trigger | –ö–∞–∫ | –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è |
|---|---|---|
| **Command Palette** | `Ctrl+P` ‚Üí "Archive note" | `checkCallback`: —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã –≤ basePath, –Ω–µ –≤ _archive |
| **Context Menu** | –ü–ö–ú –Ω–∞ —Ñ–∞–π–ª–µ ‚Üí "üì¶ Archive" | `file-menu` event: —Ç–µ –∂–µ —É—Å–ª–æ–≤–∏—è |
| **Ribbon** | –ò–∫–æ–Ω–∫–∞ sync –≤ sidebar | –¢–æ–ª—å–∫–æ sync, –Ω–µ archive |

–ö–Ω–æ–ø–∫–∞ **–≤–Ω—É—Ç—Ä–∏ –∑–∞–º–µ—Ç–∫–∏** (–≤ —Ç–µ–ª–µ markdown) ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ `registerMarkdownCodeBlockProcessor`:

```typescript
// –ï—Å–ª–∏ –≤ –∑–∞–º–µ—Ç–∫–µ –Ω–∞–ø–∏—Å–∞—Ç—å:
// ```archivistbot-actions
// ```
// Plugin —Ä–µ–Ω–¥–µ—Ä–∏—Ç –∫–Ω–æ–ø–∫—É "üì¶ Archive" –ø—Ä—è–º–æ –≤ preview
this.registerMarkdownCodeBlockProcessor(
  "archivistbot-actions",
  (source, el, ctx) => {
    const btn = el.createEl("button", { text: "üì¶ –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å" });
    btn.classList.add("archivistbot-archive-btn");
    btn.addEventListener("click", async () => {
      const file = this.app.vault.getAbstractFileByPath(ctx.sourcePath);
      if (file instanceof TFile) {
        await this.archiver.archive(file);
      }
    });
  }
);
```

–ò–ª–∏ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** —á–µ—Ä–µ–∑ `registerMarkdownPostProcessor` ‚Äî –∏–Ω–∂–µ–∫—Ç–∏—Ç—å –∫–Ω–æ–ø–∫—É –≤ –∫–∞–∂–¥—É—é –∑–∞–º–µ—Ç–∫—É –∏–∑ basePath (–±–µ–∑ —Ä—É—á–Ω–æ–≥–æ `\`\`\`archivistbot-actions`):

```typescript
this.registerMarkdownPostProcessor((el, ctx) => {
  // –¢–æ–ª—å–∫–æ –¥–ª—è —Ñ–∞–π–ª–æ–≤ –≤ basePath –∏ –Ω–µ –≤ _archive
  if (!ctx.sourcePath.startsWith(this.settings.vaultBasePath + "/")) return;
  if (ctx.sourcePath.includes("/_archive/")) return;

  // –ù–µ –¥–æ–±–∞–≤–ª—è—Ç—å –µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ —É–∂–µ –µ—Å—Ç—å
  if (el.querySelector(".archivistbot-archive-btn")) return;

  // –í—Å—Ç–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –≤ –∫–æ–Ω–µ—Ü –ø–µ—Ä–≤–æ–≥–æ –±–ª–æ–∫–∞
  const firstChild = el.firstElementChild;
  if (!firstChild) return;

  const container = el.createDiv({ cls: "archivistbot-actions" });
  const btn = container.createEl("button", {
    text: "üì¶ –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å",
    cls: "archivistbot-archive-btn",
  });
  btn.addEventListener("click", async () => {
    const file = this.app.vault.getAbstractFileByPath(ctx.sourcePath);
    if (file instanceof TFile) {
      await this.archiver.archive(file);
    }
  });
});
```

‚ö†Ô∏è **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—á–Ω–∏ —Å Command Palette + Context Menu. Inline-–∫–Ω–æ–ø–∫—É –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ. PostProcessor –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–∞–ø—Ä–∏–∑–Ω—ã–º (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ä–µ-—Ä–µ–Ω–¥–µ—Ä–µ, –º–æ–∂–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏). CodeBlock (`\`\`\`archivistbot-actions`) ‚Äî —Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç inline-–∫–Ω–æ–ø–∫–∏.

---

## 6 ¬∑ styles.css

```css
/* –ö–Ω–æ–ø–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ */
.archivistbot-archive-btn {
  cursor: pointer;
  padding: 4px 12px;
  border-radius: 4px;
  border: 1px solid var(--background-modifier-border);
  background: var(--background-secondary);
  color: var(--text-normal);
  font-size: var(--font-ui-small);
  transition: background 0.15s ease;
}

.archivistbot-archive-btn:hover {
  background: var(--background-modifier-hover);
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π */
.archivistbot-actions {
  margin-top: 8px;
  padding: 8px 0;
  border-top: 1px solid var(--background-modifier-border);
}

/* Archive modal */
.archivistbot-archive-btn.is-cta {
  margin-bottom: 4px;
}
```

---

## 7 ¬∑ Dev Workflow

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
cd plugin
npm install
```

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# –í–∞—Ä–∏–∞–Ω—Ç A: symlink –≤ vault (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π)
# –°–æ–∑–¥–∞–π –ø–∞–ø–∫—É .obsidian/plugins/archivistbot –≤ dev vault
# –ó–∞–ø—É—Å–∫–∞–π:
npm run dev
# esbuild –≤ watch-mode, –ø–∏—à–µ—Ç main.js –≤ plugin/main.js
# –°–∫–æ–ø–∏—Ä—É–π (–∏–ª–∏ symlink) main.js + manifest.json + styles.css –≤ vault

# –í–∞—Ä–∏–∞–Ω—Ç B: outfile –ø—Ä—è–º–æ –≤ vault
# –ü–æ–º–µ–Ω—è–π outfile –≤ esbuild.config.mjs:
# outfile: "/path/to/vault/.obsidian/plugins/archivistbot/main.js"
```

### Build

```bash
npm run build    # tsc check + esbuild production (minified, no sourcemap)
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å community bot: `docker-compose up -d`
2. –û—Ç–∫—Ä—ã—Ç—å Obsidian dev vault
3. –í–∫–ª—é—á–∏—Ç—å plugin –≤ Settings ‚Üí Community Plugins
4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ –≤ TG –±–æ—Ç
5. –ü–æ–¥–æ–∂–¥–∞—Ç—å sync interval –∏–ª–∏ –Ω–∞–∂–∞—Ç—å ribbon icon
6. –ó–∞–º–µ—Ç–∫–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –≤ `VoiceNotes/{category}/`
7. –ü–ö–ú –Ω–∞ –∑–∞–º–µ—Ç–∫–µ ‚Üí "üì¶ Archive" ‚Üí –≤—ã–±—Ä–∞—Ç—å resolution ‚Üí –∑–∞–º–µ—Ç–∫–∞ –≤ `_archive/`

---

## 8 ¬∑ –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

| # | –ó–∞–¥–∞—á–∞ | –í—ã—Ö–æ–¥ |
|---|---|---|
| 1 | Scaffold: –≤—Å–µ –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª—ã | package.json, manifest.json, tsconfig.json, esbuild.config.mjs |
| 2 | types.ts | –ó–µ—Ä–∫–∞–ª–æ NoteResponse + API –∫–æ–Ω—Ç—Ä–∞–∫—Ç |
| 3 | settings.ts | Settings interface + SettingTab |
| 4 | api-client.ts | REST –∫–ª–∏–µ–Ω—Ç —Å requestUrl |
| 5 | note-writer.ts | NoteResponse ‚Üí .md –≤ vault |
| 6 | sync-engine.ts | Polling + mark-synced |
| 7 | main.ts (–±–µ–∑ archiver) | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π plugin: sync —Ä–∞–±–æ—Ç–∞–µ—Ç |
| 8 | **‚úì checkpoint** | –ó–∞–º–µ—Ç–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è, –∫–Ω–æ–ø–∫–∞ sync –≤ ribbon |
| 9 | archiver.ts | Modal + frontmatter + move |
| 10 | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è archive –≤ main.ts | Command + context menu |
| 11 | styles.css | –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ |
| 12 | CodeBlock processor (–æ–ø—Ü.) | `\`\`\`archivistbot-actions` inline-–∫–Ω–æ–ø–∫–∞ |
| 13 | version-bump.mjs + versions.json | Release workflow |
| 14 | README.md –¥–ª—è plugin/ | –£—Å—Ç–∞–Ω–æ–≤–∫–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ |

---

## 9 ¬∑ –ù–µ –≤–æ—à–ª–æ (backlog)

- **OpenAPI codegen** ‚Äî `openapi-typescript` –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ types.ts –∏–∑ Core
- **Auth flow** ‚Äî –±–æ—Ç –≤ TG –≤—ã–¥–∞—ë—Ç –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–¥ ‚Üí –≤–≤–æ–¥ –≤ settings ‚Üí –æ–±–º–µ–Ω –Ω–∞ Bearer token. –ü–æ–∫–∞ ‚Äî —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ —Ç–æ–∫–µ–Ω–∞
- **Offline retry** ‚Äî exponential backoff –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö, –æ—á–µ—Ä–µ–¥—å –Ω–µ—É–¥–∞–≤—à–∏—Ö—Å—è mark-synced
- **Status bar details** ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å "last sync: 2 min ago", "3 notes pending"
- **Conflict resolution** ‚Äî —á—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–æ —Å –¥—Ä—É–≥–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º (overwrite? rename?)
- **Dashboard.md** ‚Äî Dataview queries –æ—Å—Ç–∞—é—Ç—Å—è, –ø–ª–∞–≥–∏–Ω –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç Dashboard
- **Mobile testing** ‚Äî requestUrl —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–æ–∫ –Ω–∞ iOS/Android
- **Hot reload** ‚Äî [obsidian-plugin-dev](https://www.npmjs.com/package/obsidian-plugin-dev) –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ reload –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- **PostProcessor vs CodeBlock** ‚Äî PostProcessor –∏–Ω–∂–µ–∫—Ç–∏—Ç –∫–Ω–æ–ø–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –∫–∞–∂–¥—É—é –∑–∞–º–µ—Ç–∫—É, CodeBlock —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏. –í—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥
- **Obsidian community release** ‚Äî PR –≤ obsidianmd/obsidian-releases, –Ω—É–∂–µ–Ω —Å—Ç–∞–±–∏–ª—å–Ω—ã–π API
- **Plugin CI** ‚Äî npm test + npm run build –≤ GitHub Actions (—É–∂–µ –µ—Å—Ç—å –≤ ci.yml, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å plugin job)
- **Unarchive command** ‚Äî –æ–±—Ä–∞—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: –∏–∑ _archive –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ—Å–Ω–æ–≤–Ω—É—é –ø–∞–ø–∫—É, —É–±—Ä–∞—Ç—å resolution/archived_at
